<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Worlds that are larger than the moon of Makemake</title>
    <script src="../d3/d3.min.js"></script>
    <style>
        circle {
            fill: orange;
            opacity: 1
        }

        text {
            font-size: 10pt;
            font-family: sans-serif;
            fill: white;
        }

        svg {
            background: black;
        }

        h1 {
            font-family: sans-serif;
            color: white;
            text-align: center;
            font-size: 7pt;
        }

        body {
            background: black;
        }

    </style>
</head>
<body>
<h1><span class="number"></span> worlds that are larger than the moon of Makemake</h1>
<script>
    var width = 1000;
    var height = 12850;
    var space = 15;

    d3.json("data/sol_2016.json", function (data) {
        console.log(data)
        drawObjects(d3.merge([data.planets, data.tnos, data.asteroids, data.centaurs]));
    });

    var dwarf = new Set(["Ceres", "Pluto", "Eris", "Makemake", "Haumea"]);

    var color = function (d) {
        if (d.category == "gaseous") return "orange";
        else if (d.category == "rocky")   return "forestgreen";
        else if (dwarf.has(d.name))   return "olive";
        else if (d.planet)   return "coral";
        else if (d.semiMajorAxisAU > 30.1) return "gray";
        else if (d.category == "centaur") return "lightgray";
        else return "deepskyblue";
    }

    var drawObjects = function (planets) {
        console.log(planets);

        var satellites = [];
        planets.forEach(function (d) {
            if (d.satellites) {
                d.satellites.forEach(function (e) {
                    console.log(d.name)
                    e["planet"] = d.name;
                });
                satellites = d3.merge([satellites, d.satellites]);
            }
        });

        var objects = d3.merge([planets, satellites]).filter(function (d) {
            return d.diameterKm >= 175;
        });

        var objectsTotal = objects.length;
        var objectsLarger = objects.filter(function (d) {
            return d.diameterKm > 175;
        }).length;
        d3.selectAll(".number").html(function () {
            return objectsLarger;
        });

        objects.sort(function (a, b) {
            return d3.descending(a.diameterKm, b.diameterKm);
        })

        var scale_d = d3.scale.linear()
                .domain([0, d3.max(objects, function (d) {
                    return d.diameterKm
                })])
                .range([0, width * .8 - space]);

        console.log(scale_d(3000))

        var scale_n = d3.scale.linear()
                .domain([0, d3.sum(objects, function (d) {
                    return d.diameterKm
                })])
                .range([space, height - objects.length * space]);

        var coord_n = function (d, i) {
            var previousDiameters = d3.sum(objects, function (d, j) {
                if (j < i) return d.diameterKm;
            })
            return space + i * space + scale_d(d.diameterKm / 2) + scale_d(previousDiameters);
        }

        var svg = d3.select("body")
                .append("div")
                .attr("width", width)
                .attr("height", height)
                .append("svg")
                .attr("viewBox", "0 0 " + width + " " + height);

        var entries = svg
                .selectAll(".entry")
                .data(objects)
                .enter()
                .append("g")
                .attr("class", "entry");

        entries.append("circle")
                .attr("r", function (d) {
                    return scale_d(d.diameterKm / 2)
                })
                .attr("cx", width / 2)
                .attr("cy", function (d, i) {
                    return coord_n(d, i);
                })
                .style("fill", function (d) {
                    return color(d);
                });

        entries.append("text").attr("class", "name")
                .text(function (d) {
                    if (dwarf.has(d.name)) {
                        return d.name + " (Dwarf planet)"
                    } else if (d.semiMajorAxisAU > 30.1) {
                        return d.name + " " + (d.designation == d.name ? "" : d.designation) + " (TNO)";
                    } else if (d.semiMajorAxisAU > 1.52 && d.semiMajorAxisAU < 5.2) {
                        return d.name + " (Asteroid)";
                    } else if (d.planet) {
                        return d.name + " (Satellite of " + d.planet + ")";
                    } else if (d.category == "centaur") {
                        return d.name + " (Centaur)";
                    } else return d.name;
                })
                .attr("x", function (d) {
                    return width / 2 + scale_d(d.diameterKm / 2) + 20;
                })
                .attr("y", function (d, i) {
                    return coord_n(d, i) + 5;
                })
                .style("fill", function (d) {
                    return color(d);
                });

        entries.append("text").attr("class", "diameter")
                .style("text-anchor", "end")
                .text(function (d) {
                    return d.diameterKm + " km";
                })
                .attr("x", function (d) {
                    return width / 2 - scale_d(d.diameterKm / 2) - 20;
                })
                .attr("y", function (d, i) {
                    return coord_n(d, i) + 5;
                })
                .style("fill", function (d) {
                    return color(d);
                });

        entries.on("mouseover", function (d) {
                    if (scale_d(d.diameterKm / 2) < width / 100) {
                        d3.select(this).select("circle")
                                .transition()
                                .attr("r", width / 100);
                    }
                    d3.select(this).selectAll("text")
                                .style("font-size", "13pt")
                                .style("font-weight", "bold");
                })
                .on("mouseout", function (d) {
                    d3.select(this).select("circle")
                            .transition()
                            .attr("r", scale_d(d.diameterKm / 2));
                    d3.select(this).selectAll("text")
                            .style("font-size", "10pt")
                            .style("font-weight", "normal");
                });

    }

</script>
</body>
</html>